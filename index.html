<html>
<head>
    <meta content="">
    <style>

	html * {
		font-size: 1em !important;
		color: #000 !important;
		font-family: Roboto Mono !important;
	}

	.column {
		float: left;
		width: calc(50% - 20px);
		padding: 10px;
	}

	/* Clear floats after the columns */
	.row:after {
		content: "";
		display: table;
		clear: both;
	}
	
	textarea {
		resize: none;
		width: 100%;
		height: calc(100% - 85px);
		background-color: #e8e8e8;
	}
	</style>
</head>
<body>
  <label for="preset">Choose a preset:</label>
  <select id="preset" onchange="load_preset();">
	<option value="tone">Tone Generator</option>
	<option value="empty">Empty</option>
	<option value="pentatonic">Pentatonic Melody</option>
	<option value="additive">Additive Magic</option>
  </select>
<div class="row">
  <div class="column"><textarea id="code">osc~ 440 -> output</textarea></div>
  <div class="column"><textarea id="out" style="background-color: #bbbbbb;" disabled=true></textarea></div>
</div>
  <button onclick="parse_code()">Interpret</button>
  <label id="indicator">WASM still loading...</label>
  <script>
		  var datal = [ 0 ];
		  var datar = [ 0 ];
		  var length = 44100;
		
		  var mono = true;
		  function set_mono() { mono = true; }
		  function unset_mono() { mono = false; }
     	  function set_length(x) { length = x; }
		  function add_to_data(x, y) {
			  datal.push(x);
			  datar.push(y);
		  }

		  var Module = {
			  'onRuntimeInitialized': function() { document.getElementById("indicator").innerHTML = "WASM is ready."; },
			  'print': function(message) { document.getElementById("out").innerHTML += message + '\n'; }
		  };
	
	      function parse_code() {
			  Module.parse(" " + document.getElementById("code").value);
			  for (var n = 0; n < length; n++) Module.run();
			  var audio_context = new (window.AudioContext || window.webkitAudioContext)();

			  var buffer = audio_context.createBuffer(2, length, 44100);

			  var x = buffer.getChannelData(0);
			  var y = buffer.getChannelData(1);
			  for (var n = 0; n < length; n++) {
				  if (mono) {
					  x[n] = datal[n];
					  y[n] = datal[n];
				  }
				  else {
  					  x[n] = datal[n];
					  y[n] = datar[n];
				  }
			  }
			  var source = audio_context.createBufferSource();

			  source.buffer = buffer;

			  source.connect(audio_context.destination);

			  source.start();
			  datal = [];
			  datar = [];
		  };

		 
		  function load_preset() {
			  console.log("Loading Preset");
			  if (document.getElementById("preset").value == "empty") {
				  console.log("empty");
				document.getElementById("code").value = ""
			}
			if (document.getElementById("preset").value == "tone") {
				document.getElementById("code").value = "osc~ 440 -> output"
			}

			if (document.getElementById("preset").value == "pentatonic") {
				document.getElementById("code").value = `
&length sf * 10

; Generate the frequencies of the pentatonic scale
scale: { 0, 2, 4, 7, 9 }
root: 330
freqs: (2^(1/12))^scale * root

seed: 7


vca: mult~
c: clock~ sf / 3
clock: add~ 0
c -> ddl~ seed -> clock

; Trigger envelope into VCA
eg: eg~
clock
-> 0|eg
-> filter~ 30
-> 1|vca


; Randomise decay time
snh: snh~
clock -> 1|snh
noise~
-> *0.5 -> +0.5
-> * sf/3 + sf/10
-> snh -> 1|eg


; Generate sine signal and output
index: snh~
clock -> 1|index
sound: add~ 0

noise~ -> index
-> *0.5 -> +0.5
-> *4.9
-> seq~ freqs
-> osc~
-> vca
-> sound


; Delay circuit
delay: ddl~ 44100 / 2

sound -> delay
-> mult~ 0.6
-> delay

-> *0.5 -> sat~ -> output
`;
			}

			if (document.getElementById("preset").value == "additive") {
				document.getElementById("code").value = `
&length sf * 2

N: 30
n: 1..N

partials: [N] osc~ n*200
gain: [N] div~ n
gate: [N] mult~ n*0
threshold: [N] comp~ n / 20

partials => gain => gate >> *0.5 -> output
timer~ 1 <> threshold => 1|gate
`
			}
		}

	  </script><script src="a.out.js">
		  
</script> </body>
</html>
